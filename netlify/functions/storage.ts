w Date(),
  },
  {
    id: 22,
    name: "Doce Prest√≠gio mineiro",
    description: "Vers√£o mineira do cl√°ssico prest√≠gio. Doce de leite com coco ralado e cobertura de chocolate. Simplesmente irresist√≠vel.",
    price500g: "24.90",
    price1kg: "49.80",
    originalPrice500g: "41.90",
    originalPrice1kg: "83.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/IdAa9ngm.jpg",
    imageUrls: ["https://i.imgur.com/IdAa9ngm.jpg"],
    weight: "300g",
    stock: 30,
    featured: true,
    discount: 40,
    rating: "4.9",
    reviews: 167,
    createdAt: new Date(),
  },
  {
    id: 23,
    name: "Doce de Cocada com Maracuj√°",
    description: "Cocada cremosa com polpa de maracuj√° natural. Combina√ß√£o perfeita entre o doce do coco e o azedinho do maracuj√°.",
    price500g: "32.90",
    price1kg: "65.80",
    originalPrice500g: "43.90",
    originalPrice1kg: "87.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/p6wwtEtm.jpg",
    imageUrls: ["https://i.imgur.com/p6wwtEtm.jpg"],
    weight: "350g",
    stock: 20,
    featured: false,
    discount: 25,
    rating: "4.7",
    reviews: 112,
    createdAt: new Date(),
  },
  {
    id: 24,
    name: "Doce casadinho",
    description: "Tradicional doce de festa junina. Duas metades de biscoito recheadas com doce de leite cremoso. Nostalgia em cada mordida.",
    price500g: "27.90",
    price1kg: "55.80",
    originalPrice500g: "45.00",
    originalPrice1kg: "90.00",
    category: "doces",
    imageUrl: "https://i.imgur.com/WoKuC7Tm.jpg",
    imageUrls: ["https://i.imgur.com/WoKuC7Tm.jpg"],
    weight: "250g",
    stock: 35,
    featured: false,
    discount: 38,
    rating: "4.5",
    reviews: 89,
    createdAt: new Date(),
  },
  {
    id: 25,
    name: "Doce de leite",
    description: "Doce de leite puro artesanal, cremoso e no ponto certo. Feito com leite fresco e muito carinho. Tradi√ß√£o mineira.",
    price500g: "22.90",
    price1kg: "45.80",
    originalPrice500g: "40.00",
    originalPrice1kg: "80.00",
    category: "doces",
    imageUrl: "https://i.imgur.com/7l56V5mm.jpg",
    imageUrls: ["https://i.imgur.com/7l56V5mm.jpg"],
    weight: "400g",
    stock: 40,
    featured: true,
    discount: 42,
    rating: "4.9",
    reviews: 234,
    createdAt: new Date(),
  },
  {
    id: 26,
    name: "Doce de leite com caf√©",
    description: "Doce de leite enriquecido com caf√© especial mineiro. Sabor √∫nico para os amantes de caf√©. Cremoso e arom√°tico.",
    price500g: "26.90",
    price1kg: "53.80",
    originalPrice500g: "45.00",
    originalPrice1kg: "90.00",
    category: "doces",
    imageUrl: "https://i.imgur.com/dEVNMOdm.jpg",
    imageUrls: ["https://i.imgur.com/dEVNMOdm.jpg"],
    weight: "400g",
    stock: 28,
    featured: true,
    discount: 40,
    rating: "4.8",
    reviews: 145,
    createdAt: new Date(),
  },
  {
    id: 27,
    name: "Doce de Pingo de Leite com Amendoim",
    description: "Doce de leite especial com amendoim torrado e crocante. Textura cremosa com peda√ßos generosos de amendoim.",
    price500g: "58.90",
    price1kg: "117.80",
    originalPrice500g: "80.90",
    originalPrice1kg: "161.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/o74KsOom.jpg",
    imageUrls: ["https://i.imgur.com/o74KsOom.jpg"],
    weight: "500g",
    stock: 15,
    featured: false,
    discount: 27,
    rating: "4.7",
    reviews: 93,
    createdAt: new Date(),
  },
  {
    id: 28,
    name: "Doce de Cocada com Ameixa",
    description: "Cocada diferenciada com peda√ßos de ameixa seca. Combina√ß√£o sofisticada de sabores, textura macia e equilibrada.",
    price500g: "32.90",
    price1kg: "65.80",
    originalPrice500g: "43.90",
    originalPrice1kg: "87.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/Rt7nWy8m.jpg",
    imageUrls: ["https://i.imgur.com/Rt7nWy8m.jpg"],
    weight: "350g",
    stock: 12,
    featured: false,
    discount: 25,
    rating: "4.6",
    reviews: 67,
    createdAt: new Date(),
  },
  {
    id: 29,
    name: "Doce de Ab√≥bora com Coco",
    description: "Doce caseiro de ab√≥bora com coco ralado fresco. Receita tradicional da vov√≥, com sabor que remete √† inf√¢ncia.",
    price500g: "27.90",
    price1kg: "55.80",
    originalPrice500g: "44.00",
    originalPrice1kg: "88.00",
    category: "doces",
    imageUrl: "https://i.imgur.com/glyYwmbm.jpg",
    imageUrls: ["https://i.imgur.com/glyYwmbm.jpg"],
    weight: "450g",
    stock: 25,
    featured: false,
    discount: 36,
    rating: "4.5",
    reviews: 78,
    createdAt: new Date(),
  },
  {
    id: 30,
    name: "Doce Quebra-Queixo",
    description: "Tradicional doce mineiro feito com rapadura e amendoim. Crocante e saboroso, derrete na boca. Energia pura!",
    price500g: "36.90",
    price1kg: "73.80",
    originalPrice500g: "60.90",
    originalPrice1kg: "121.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/ded8MyOm.jpg",
    imageUrls: ["https://i.imgur.com/ded8MyOm.jpg"],
    weight: "300g",
    stock: 20,
    featured: false,
    discount: 39,
    rating: "4.7",
    reviews: 102,
    createdAt: new Date(),
  },
  {
    id: 31,
    name: "Doce de leite Dom",
    description: "Doce de leite premium da marca Dom. Textura aveludada e sabor incompar√°vel. Produzido com leite selecionado.",
    price500g: "44.90",
    price1kg: "89.80",
    originalPrice500g: "80.90",
    originalPrice1kg: "161.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/lHpdysAm.jpg",
    imageUrls: ["https://i.imgur.com/lHpdysAm.jpg"],
    weight: "450g",
    stock: 10,
    featured: true,
    discount: 44,
    rating: "4.9",
    reviews: 189,
    createdAt: new Date(),
  },
  {
    id: 32,
    name: "Goiabada cremosa Tia Carla",
    description: "Goiabada cremosa artesanal da Tia Carla. Feita com goiabas maduras selecionadas, textura perfeita para acompanhar queijos.",
    price500g: "32.90",
    price1kg: "65.80",
    originalPrice500g: "60.90",
    originalPrice1kg: "121.80",
    category: "doces",
    imageUrl: "https://i.imgur.com/uJPxQ3Fm.jpg",
    imageUrls: ["https://i.imgur.com/uJPxQ3Fm.jpg"],
    weight: "400g",
    stock: 26,
    featured: true,
    discount: 46,
    rating: "4.8",
    reviews: 156,
    createdAt: new Date(),
  },
  {
    id: 33,
    name: "Doce de banana zero a√ß√∫car",
    description: "Doce de banana sem adi√ß√£o de a√ß√∫car, ado√ßado naturalmente. Ideal para dietas restritivas. Sabor aut√™ntico da fruta.",
    price500g: "24.90",
    price1kg: "49.80",
    originalPrice500g: "40.00",
    originalPrice1kg: "80.00",
    category: "doces",
    imageUrl: "https://i.imgur.com/dOM2hiam.jpg",
    imageUrls: ["https://i.imgur.com/dOM2hiam.jpg"],
    weight: "350g",
    stock: 32,
    featured: false,
    discount: 37,
    rating: "4.6",
    reviews: 124,
    createdAt: new Date(),
  }
];

let cartItems: CartItem[] = [];
let cartIdCounter = 1;
let orders: any[] = [];
let orderIdCounter = 1;

export const storage = {
  getAllProducts: async (): Promise<Product[]> => {
    return products;
  },

  getCartItems: async (sessionId: string): Promise<CartItem[]> => {
    const items = cartItems.filter(item => item.sessionId === sessionId);
    // Add product details
    return items.map(item => ({
      ...item,
      product: products.find(p => p.id === item.productId)
    }));
  },

  addToCart: async (cartData: {
    sessionId: string;
    productId: number;
    quantity: number;
    size: string;
    price: string;
  }): Promise<CartItem> => {
    const newItem: CartItem = {
      id: cartIdCounter++,
      ...cartData
    };
    cartItems.push(newItem);
    return newItem;
  },

  removeFromCart: async (itemId: number): Promise<void> => {
    cartItems = cartItems.filter(item => item.id !== itemId);
  },

  clearCart: async (sessionId: string): Promise<void> => {
    cartItems = cartItems.filter(item => item.sessionId !== sessionId);
  },

  createOrder: async (orderData: any): Promise<any> => {
    console.log('=== IN√çCIO CREATE ORDER ===');
    console.log('Order data recebido:', JSON.stringify(orderData, null, 2));
    
    try {
      const blackCatApiKey = process.env.BLACKCAT_API_KEY;
      
      console.log('Verificando API Key...');
      console.log('API Key presente:', !!blackCatApiKey);
      console.log('Primeiros 10 caracteres da key:', blackCatApiKey ? blackCatApiKey.substring(0, 10) + '...' : 'undefined');
      
      if (!blackCatApiKey) {
        console.error('‚ùå BLACKCAT_API_KEY n√£o configurada');
        throw new Error('BLACKCAT_API_KEY n√£o configurada no ambiente');
      }

      // Gerar identificador √∫nico mais robusto
      const identificador = `PEDIDO-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
      console.log('üìù Identificador gerado:', identificador);

      // Validar valor
      const valorFloat = parseFloat(orderData.total);
      if (isNaN(valorFloat) || valorFloat <= 0) {
        throw new Error(`Valor inv√°lido: ${orderData.total}`);
      }
      console.log('üí∞ Valor validado:', valorFloat);

      // Preparar payload para BlackCat
      const pixPayload = {
        valor: valorFloat,
        identificador: identificador,
        solicitacao_pagador: "Pagamento - T√°bua de Minas"
      };
      
      console.log('üì§ Payload para BlackCat:', JSON.stringify(pixPayload, null, 2));

      console.log('üîÑ Fazendo requisi√ß√£o para BlackCat API...');
      
      // Fazer requisi√ß√£o com timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos

      const pixResponse = await fetch('https://api.blackcat.bio/pix/solicitar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${blackCatApiKey}`,
          'User-Agent': 'Tabua-de-Minas/1.0',
          'Accept': 'application/json'
        },
        body: JSON.stringify(pixPayload),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      console.log('üì• Resposta da BlackCat:');
      console.log('- Status:', pixResponse.status);
      console.log('- Status Text:', pixResponse.statusText);
      console.log('- Headers:', Object.fromEntries(pixResponse.headers));

      if (!pixResponse.ok) {
        const errorText = await pixResponse.text();
        console.error('‚ùå Erro da BlackCat API:', errorText);
        console.error('‚ùå Status completo:', {
          status: pixResponse.status,
          statusText: pixResponse.statusText,
          body: errorText
        });
        
        throw new Error(`BlackCat API Error ${pixResponse.status}: ${errorText}`);
      }

      const pixPayment = await pixResponse.json();
      console.log('‚úÖ PIX Payment recebido:', JSON.stringify(pixPayment, null, 2));

      // Validar resposta da BlackCat
      if (!pixPayment.pix || !pixPayment.pix.qrcode) {
        console.error('‚ùå Resposta inv√°lida da BlackCat:', pixPayment);
        throw new Error('Resposta inv√°lida da BlackCat API - QR Code n√£o encontrado');
      }

      const order = {
        id: orderIdCounter++,
        ...orderData,
        pixCode: pixPayment.pix.qrcode,
        pixKey: pixPayment.pix.chave || 'N/A',
        blackCatTransactionId: pixPayment.identificador,
        blackCatResponse: pixPayment, // Para debug
        createdAt: new Date(),
        status: 'pending'
      };
      
      orders.push(order);
      
      console.log('‚úÖ Pedido criado com sucesso:', {
        orderId: order.id,
        transactionId: order.blackCatTransactionId,
        pixCodeLength: order.pixCode.length
      });
      console.log('=== FIM CREATE ORDER ===');
      
      return order;
      
    } catch (error) {
      console.error('‚ùå ERRO GERAL em createOrder:');
      console.error('- Message:', error.message);
      console.error('- Stack:', error.stack);
      console.error('- Name:', error.name);
      
      if (error.name === 'AbortError') {
        console.error('‚ùå Timeout na requisi√ß√£o para BlackCat');
        throw new Error('Timeout ao conectar com a API de pagamento');
      }
      
      console.log('=== FIM CREATE ORDER (ERRO) ===');
      throw new Error(`Erro ao gerar c√≥digo PIX: ${error.message}`);
    }
  },

  getOrdersByTransactionId: async (transactionId: string): Promise<any[]> => {
    return orders.filter(order => order.blackCatTransactionId === transactionId);
  },

  updateOrderStatus: async (orderId: number, status: string): Promise<any | undefined> => {
    const order = orders.find(order => order.id === orderId);
    if (order) {
      order.status = status;
    }
    return order;
  }
};
